<!DOCTYPE html>
<html>
<head>
<title>Package File Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
* {
  box-sizing: border-box;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  font-size: 16px;
  line-height: 1.5;
  max-width: 800px;
  margin: 0 auto;
  padding: 1rem;
  color: #333;
}
h1 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
}
input[type="text"] {
  font-size: 16px;
  width: 100%;
  margin-bottom: 0.75rem;
  padding: 0.75rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}
input[type="text"]:focus {
  outline: none;
  border-color: #007aff;
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
}
button {
  font-size: 16px;
  padding: 0.75rem 1.25rem;
  background: #007aff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
}
button:active {
  background: #005ecb;
}
p {
  font-size: 0.875rem;
  color: #666;
  margin-top: 0.75rem;
}
p code {
  font-size: 0.75rem;
  background: #f0f0f0;
  padding: 0.15rem 0.3rem;
  border-radius: 3px;
  word-break: break-all;
}
#fileList {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 0;
  margin-top: 1rem;
  overflow: hidden;
}
#fileList h3 {
  font-size: 0.875rem;
  font-weight: 600;
  margin: 0;
  padding: 0.75rem 1rem;
  background: #f8f8f8;
  border-bottom: 1px solid #e0e0e0;
}
.file-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  font-size: 0.875rem;
  word-break: break-all;
  transition: background 0.1s;
}
.file-item:hover {
  background: #f5f5f5;
}
.file-item:active {
  background: #e8e8e8;
}
.file-item.selected {
  background: #e7f1ff;
  border-bottom: none;
}
.file-content {
  border-bottom: 1px solid #eee;
}
.file-content pre {
  border-top: 1px solid #e0e0e0;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  background-color: #fafafa;
  padding: 0;
  margin: 0;
  max-height: 60vh;
  overflow-y: auto;
  font-size: 0.8125rem;
  line-height: 1.4;
}
.line-table {
  width: 100%;
  border-collapse: collapse;
}
.line-table td {
  padding: 0;
  vertical-align: top;
}
.line-num {
  width: 1%;
  min-width: 3em;
  padding: 0 1rem 0 0.5rem;
  text-align: right;
  user-select: none;
  font-size: 0.75rem;
  color: #999;
  border-right: 1px solid #e0e0e0;
  background: #f5f5f5;
}
.line-num a {
  color: inherit;
  text-decoration: none;
  display: block;
}
.line-num a:hover {
  color: #007aff;
}
.line-code {
  padding-left: 0.75rem;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.line-row.highlighted {
  background: #fffbdd;
}
.line-row.highlighted .line-num {
  background: #f5efaa;
  color: #666;
}
.status {
  padding: 1rem;
  color: #666;
  font-size: 0.875rem;
}
@media (min-width: 500px) {
  body {
    padding: 2rem;
  }
  h1 {
    font-size: 1.75rem;
  }
  button {
    width: auto;
  }
}
</style>
</head>
<body>
<h1>Package File Browser</h1>
<input type="text" id="urlInput" placeholder="Package name (e.g. requests) or URL to .whl/.zip file" onkeydown="if(event.key==='Enter')fetchAndUnpackFile()">
<button onclick="fetchAndUnpackFile()">Unpack File</button>
<p>Enter a PyPI package name like <code>requests</code> or <code>llm-mistral</code> (<a href="?package=llm-mistral">try it</a>), or paste a direct URL to a .whl or .zip file.</p>
<div id="fileList" style="display: none"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
function updateUrl(input, fragment = null) {
    const params = new URLSearchParams();
    if (input.startsWith('http://') || input.startsWith('https://')) {
        params.set('url', input);
    } else {
        params.set('package', input);
    }
    const hash = fragment ? '#' + fragment : '';
    history.replaceState(null, '', '?' + params.toString() + hash);
}

function encodeFragment(filename, lineNum = null) {
    // Encode filename for use in URL fragment
    const encoded = encodeURIComponent(filename).replace(/%2F/g, '/');
    if (lineNum !== null) {
        return encoded + '--L' + lineNum;
    }
    return encoded;
}

function parseFragment(fragment) {
    if (!fragment) return { filename: null, lineNum: null };
    // Check for line number suffix
    const match = fragment.match(/^(.+)--L(\d+)$/);
    if (match) {
        return {
            filename: decodeURIComponent(match[1]),
            lineNum: parseInt(match[2], 10)
        };
    }
    return {
        filename: decodeURIComponent(fragment),
        lineNum: null
    };
}

function formatContentWithLineNumbers(content, filename) {
    const lines = content.split('\n');
    let html = '<table class="line-table"><tbody>';
    lines.forEach((line, index) => {
        const lineNum = index + 1;
        const fragment = encodeFragment(filename, lineNum);
        const rowId = `${encodeURIComponent(filename)}--L${lineNum}`;
        html += `<tr class="line-row" id="${escapeHtml(rowId)}">`;
        html += `<td class="line-num"><a href="#${escapeHtml(fragment)}" data-line="${lineNum}">${lineNum}</a></td>`;
        html += `<td class="line-code">${escapeHtml(line) || ' '}</td>`;
        html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
}

function highlightLine(lineNum) {
    // Remove any existing highlight
    document.querySelectorAll('.line-row.highlighted').forEach(el => el.classList.remove('highlighted'));
    // Find and highlight the specified line
    const row = document.querySelector(`.line-row:nth-child(${lineNum})`);
    if (row) {
        row.classList.add('highlighted');
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function selectFile(filename, lineNum, updateHash = true) {
    const files = window.loadedFiles || [];
    const file = files.find(f => f.name === filename);
    if (!file) return;

    const fileEl = document.querySelector(`.file-item[data-filename="${CSS.escape(filename)}"]`);
    if (!fileEl) return;

    const wasSelected = fileEl.classList.contains('selected');

    // Remove any existing content and selection
    document.querySelectorAll('.file-content').forEach(el => el.remove());
    document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));

    // Toggle off if clicking the same file (only when not opening via line number)
    if (wasSelected && lineNum === null) {
        if (updateHash) {
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        return;
    }

    fileEl.classList.add('selected');

    // Insert content right after the clicked file
    const contentEl = document.createElement('div');
    contentEl.className = 'file-content';
    contentEl.innerHTML = `<pre>${formatContentWithLineNumbers(file.content, file.name)}</pre>`;
    fileEl.after(contentEl);

    // Add click handlers to line number links
    contentEl.querySelectorAll('.line-num a').forEach(a => {
        a.onclick = (e) => {
            e.preventDefault();
            const ln = parseInt(a.dataset.line, 10);
            const input = document.getElementById('urlInput').value.trim();
            updateUrl(input, encodeFragment(file.name, ln));
            highlightLine(ln);
        };
    });

    // Update URL fragment
    if (updateHash) {
        const input = document.getElementById('urlInput').value.trim();
        updateUrl(input, encodeFragment(filename, lineNum));
    }

    // Scroll to file element so it's visible
    fileEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Highlight line if specified
    if (lineNum !== null) {
        setTimeout(() => highlightLine(lineNum), 100);
    }
}

function handleFragment() {
    const fragment = window.location.hash.slice(1);
    if (!fragment) return;

    const { filename, lineNum } = parseFragment(fragment);
    if (filename) {
        selectFile(filename, lineNum, false);
    }
}

// Listen for hash changes
window.addEventListener('hashchange', handleFragment);

async function fetchAndUnpackFile() {
    let input = document.getElementById('urlInput').value.trim();
    const fileListEl = document.getElementById('fileList');

    if (!input) return;

    fileListEl.style.display = 'block';

    // Check if input is a URL or a package name
    let url = input;
    const isUrl = input.startsWith('http://') || input.startsWith('https://');

    if (!isUrl) {
        // Treat as PyPI package name
        fileListEl.innerHTML = `<div class="status">Looking up "${escapeHtml(input)}" on PyPI...</div>`;
        try {
            const pypiResponse = await fetch(`https://pypi.org/pypi/${encodeURIComponent(input)}/json`);
            if (!pypiResponse.ok) {
                fileListEl.innerHTML = `<div class="status">Package "${escapeHtml(input)}" not found on PyPI</div>`;
                return;
            }
            const pypiData = await pypiResponse.json();
            const wheelUrl = pypiData.urls?.find(u => u.url?.endsWith('.whl'));
            if (!wheelUrl) {
                fileListEl.innerHTML = `<div class="status">No wheel (.whl) found for "${escapeHtml(input)}"</div>`;
                return;
            }
            url = wheelUrl.url;
        } catch (error) {
            fileListEl.innerHTML = `<div class="status">Error looking up package: ${escapeHtml(error.message)}</div>`;
            return;
        }
    }

    // Update URL bar (preserve existing fragment)
    const existingFragment = window.location.hash.slice(1);
    updateUrl(input, existingFragment || null);

    fileListEl.innerHTML = '<div class="status">Downloading file...</div>';

    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const files = await extractFiles(arrayBuffer, url);
        fileListEl.innerHTML = '<h3>Files in package</h3>';
        window.loadedFiles = files; // Store for fragment handling
        files.forEach((file, index) => {
            const fileEl = document.createElement('div');
            fileEl.className = 'file-item';
            fileEl.textContent = file.name;
            fileEl.dataset.filename = file.name;
            fileEl.onclick = () => selectFile(file.name, null);
            fileListEl.appendChild(fileEl);
        });

        // Handle fragment after files are loaded
        handleFragment();
    } catch (error) {
        fileListEl.innerHTML = `<div class="status">Error: ${escapeHtml(error.message)}</div>`;
        console.error(error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function extractFiles(arrayBuffer, url) {
    const files = [];
    const zip = await JSZip.loadAsync(arrayBuffer);
    for (const [name, file] of Object.entries(zip.files)) {
        const content = await file.async('text');
        files.push({ name, content });
    }
    return files;
}

// Check for query params on page load
const params = new URLSearchParams(window.location.search);
const packageParam = params.get('package');
const urlParam = params.get('url');
if (packageParam || urlParam) {
    document.getElementById('urlInput').value = packageParam || urlParam;
    fetchAndUnpackFile();
}
</script>
</body>
</html>
