<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebUSB File Editor — Device File Manager</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171922;
      --ink: #f6f7fb;
      --muted: #8e95a5;
      --accent: #7c7cff;
      --danger: #ff7272;
      --ok: #65d488;
      --border: #262938;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #151824, #10131c);
      display: flex; align-items: center; gap: 14px; flex-wrap: wrap;
    }
    header h1 { font-size: 16px; margin: 0 10px 0 0; font-weight: 600; letter-spacing: .2px; }
    .controls { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    button {
      background: #1b1e2b; color: var(--ink); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
      letter-spacing: .2px; font-size: 13px;
    }
    button:hover { background: #202437; }
    button.primary { background: var(--accent); border-color: #5858ff; color: #fff; }
    button.danger { background: #2b1b1b; border-color: #3a2525; color: #ffc5c5; }
    button.success { background: #1b2b1f; border-color: #2a3d2e; color: #b3ffcc; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .pill {
      padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border);
      background: var(--panel); font-size: 12px; color: var(--muted);
    }
    .status-pill {
      padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 600;
    }
    .status-connected { background: var(--ok); color: #000; }
    .status-disconnected { background: var(--muted); color: #000; }

    main {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }

    .file-browser {
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .browser-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .browser-header h2 {
      font-size: 13px;
      margin: 0;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .file-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .file-item {
      padding: 8px 12px;
      margin-bottom: 2px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      transition: background 0.1s;
    }
    .file-item:hover {
      background: rgba(124, 124, 255, 0.1);
    }
    .file-item.selected {
      background: var(--accent);
      color: #fff;
    }
    .file-item.directory {
      font-weight: 600;
    }
    .file-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
    }

    .editor-pane {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .editor-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .editor-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-path {
      font-size: 12px;
      color: var(--muted);
      font-weight: normal;
    }
    .editor-actions {
      display: flex;
      gap: 8px;
    }
    .editor-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #editor {
      flex: 1;
      background: #0e1017;
      color: var(--ink);
      border: none;
      padding: 16px;
      font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: none;
      overflow: auto;
      tab-size: 4;
    }
    #editor:focus {
      outline: none;
    }

    .placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      padding: 40px;
    }

    .muted { color: var(--muted); font-size: 12px; }
    .modified-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }

    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: 200px 1fr;
      }
      .file-browser {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>WebUSB File Editor</h1>
    <div class="controls">
      <button id="connectBtn" class="primary">Connect Device</button>
      <span id="statusPill" class="status-pill status-disconnected">Disconnected</span>
      <button id="refreshBtn" disabled>Refresh Files</button>
      <button id="newFileBtn" disabled>New File</button>
    </div>
  </header>

  <main>
    <div class="file-browser">
      <div class="browser-header">
        <h2>Files</h2>
        <div id="fileCount" class="muted">—</div>
      </div>
      <div class="file-list" id="fileList">
        <div class="placeholder">
          Connect to a device to view files
        </div>
      </div>
    </div>

    <div class="editor-pane">
      <div class="editor-header">
        <div class="editor-title">
          <span id="fileName">No file selected</span>
          <span id="modifiedIndicator" style="display: none;" class="modified-indicator"></span>
        </div>
        <div class="editor-actions">
          <button id="saveBtn" disabled>Save</button>
          <button id="saveAsBtn" disabled>Save As...</button>
          <button id="downloadBtn" disabled>Download</button>
          <button id="deleteBtn" class="danger" disabled>Delete</button>
        </div>
      </div>
      <div class="editor-content" id="editorContent">
        <div class="placeholder">
          Select a file from the browser to start editing
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---- State ----
    const state = {
      device: null,
      connected: false,
      currentFile: null,
      currentContent: '',
      originalContent: '',
      modified: false,
      files: []
    };

    // ---- DOM Elements ----
    const connectBtn = document.getElementById('connectBtn');
    const statusPill = document.getElementById('statusPill');
    const refreshBtn = document.getElementById('refreshBtn');
    const newFileBtn = document.getElementById('newFileBtn');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');
    const fileName = document.getElementById('fileName');
    const modifiedIndicator = document.getElementById('modifiedIndicator');
    const saveBtn = document.getElementById('saveBtn');
    const saveAsBtn = document.getElementById('saveAsBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const editorContent = document.getElementById('editorContent');

    // ---- WebUSB Communication ----
    async function connectDevice() {
      if (!('usb' in navigator)) {
        alert('WebUSB is not supported in this browser. Try Chrome, Edge, or Opera.');
        return;
      }

      try {
        // Request a USB device (CircuitPython/MicroPython devices typically)
        const device = await navigator.usb.requestDevice({
          filters: [
            // CircuitPython devices
            { vendorId: 0x239A },
            // Adafruit boards
            { vendorId: 0x239A },
            // Generic CDC devices (adjust as needed)
            { vendorId: 0x2E8A }, // Raspberry Pi Pico
          ]
        });

        await device.open();

        // Find the correct configuration and interface
        if (device.configuration === null) {
          await device.selectConfiguration(1);
        }

        // Claim interface (usually interface 2 for CircuitPython WebUSB)
        const interfaceNumber = 2; // Common for CircuitPython
        try {
          await device.claimInterface(interfaceNumber);
        } catch (e) {
          console.warn('Could not claim interface 2, trying interface 0', e);
          await device.claimInterface(0);
        }

        state.device = device;
        state.connected = true;
        updateConnectionStatus();

        // Load files
        await loadFileList();
      } catch (error) {
        console.error('Connection error:', error);
        alert('Failed to connect: ' + error.message);
      }
    }

    async function disconnectDevice() {
      if (state.device) {
        try {
          await state.device.close();
        } catch (e) {
          console.error('Error closing device:', e);
        }
        state.device = null;
        state.connected = false;
        state.files = [];
        updateConnectionStatus();
        clearEditor();
        renderFileList();
      }
    }

    async function sendCommand(command) {
      if (!state.device) throw new Error('Device not connected');

      const encoder = new TextEncoder();
      const data = encoder.encode(command + '\n');

      // Send data to device (endpoint 1 is typically OUT for CircuitPython)
      await state.device.transferOut(1, data);
    }

    async function receiveData() {
      if (!state.device) throw new Error('Device not connected');

      // Receive data from device (endpoint 1 is typically IN for CircuitPython)
      const result = await state.device.transferIn(1, 64); // Read up to 64 bytes
      const decoder = new TextDecoder();
      return decoder.decode(result.data);
    }

    // ---- File Operations ----
    async function loadFileList() {
      // This is a placeholder implementation
      // In a real implementation, you would send commands to the device
      // to list files and parse the response

      // For demonstration, we'll simulate a file structure
      state.files = [
        { name: 'code.py', type: 'file', size: 1234, path: '/code.py' },
        { name: 'boot.py', type: 'file', size: 456, path: '/boot.py' },
        { name: 'lib', type: 'directory', path: '/lib' },
        { name: 'settings.toml', type: 'file', size: 89, path: '/settings.toml' },
        { name: 'README.txt', type: 'file', size: 567, path: '/README.txt' },
      ];

      renderFileList();
    }

    function renderFileList() {
      if (state.files.length === 0) {
        fileList.innerHTML = '<div class="placeholder">No files found</div>';
        fileCount.textContent = '—';
        return;
      }

      fileCount.textContent = `${state.files.length} items`;

      fileList.innerHTML = '';
      state.files.forEach(file => {
        const item = document.createElement('div');
        item.className = 'file-item' + (file.type === 'directory' ? ' directory' : '');
        if (state.currentFile === file.path) {
          item.classList.add('selected');
        }

        const icon = file.type === 'directory' ? '📁' : '📄';
        const sizeText = file.type === 'file' ? ` (${formatSize(file.size)})` : '';

        item.innerHTML = `
          <span class="file-icon">${icon}</span>
          <span>${file.name}</span>
        `;

        if (file.type === 'file') {
          item.addEventListener('click', () => openFile(file));
        } else {
          item.addEventListener('click', () => {
            alert('Directory browsing not yet implemented');
          });
        }

        fileList.appendChild(item);
      });
    }

    async function openFile(file) {
      if (state.modified && !confirm('You have unsaved changes. Discard them?')) {
        return;
      }

      state.currentFile = file.path;

      // In a real implementation, send a command to read the file
      // For now, we'll use placeholder content
      const content = await readFileFromDevice(file.path);

      state.currentContent = content;
      state.originalContent = content;
      state.modified = false;

      showEditor(content, file.name);
      renderFileList();
    }

    async function readFileFromDevice(path) {
      // Placeholder implementation
      // In reality, you would send a command to the device to read the file

      const examples = {
        '/code.py': `import board
import digitalio
import time

led = digitalio.DigitalInOut(board.LED)
led.direction = digitalio.Direction.OUTPUT

while True:
    led.value = True
    time.sleep(0.5)
    led.value = False
    time.sleep(0.5)`,
        '/boot.py': `import storage
# Disable USB drive on boot
storage.disable_usb_drive()`,
        '/settings.toml': `# CircuitPython settings
CIRCUITPY_WEB_API_PASSWORD = "passw0rd"
CIRCUITPY_WIFI_SSID = "MyNetwork"
CIRCUITPY_WIFI_PASSWORD = "password123"`,
        '/README.txt': `This is a sample file on your CircuitPython device.

You can edit this file using the WebUSB File Editor.

Features:
- View files
- Edit files
- Save changes
- Download files
- Create new files`
      };

      return examples[path] || '// File content would be loaded from device\n';
    }

    async function writeFileToDevice(path, content) {
      // Placeholder implementation
      // In reality, you would send commands to write the file to the device
      console.log('Writing to device:', path);
      console.log('Content:', content);

      // Simulate async operation
      await new Promise(resolve => setTimeout(resolve, 500));

      // Update the original content to match saved content
      state.originalContent = content;
      state.modified = false;
      updateModifiedIndicator();

      alert('File saved successfully!\n\n(In a real implementation, this would write to the device)');
    }

    async function deleteFileFromDevice(path) {
      // Placeholder implementation
      console.log('Deleting from device:', path);

      if (!confirm(`Are you sure you want to delete ${path}?`)) {
        return;
      }

      // Simulate async operation
      await new Promise(resolve => setTimeout(resolve, 300));

      // Remove from file list
      state.files = state.files.filter(f => f.path !== path);
      renderFileList();
      clearEditor();

      alert('File deleted!\n\n(In a real implementation, this would delete from the device)');
    }

    // ---- Editor ----
    function showEditor(content, filename) {
      editorContent.innerHTML = '<textarea id="editor" spellcheck="false"></textarea>';
      const editor = document.getElementById('editor');
      editor.value = content;
      editor.addEventListener('input', handleEditorChange);

      fileName.textContent = filename;

      // Enable editor buttons
      saveBtn.disabled = false;
      saveAsBtn.disabled = false;
      downloadBtn.disabled = false;
      deleteBtn.disabled = false;

      updateModifiedIndicator();
    }

    function clearEditor() {
      editorContent.innerHTML = '<div class="placeholder">Select a file from the browser to start editing</div>';
      fileName.textContent = 'No file selected';
      state.currentFile = null;
      state.currentContent = '';
      state.originalContent = '';
      state.modified = false;

      // Disable editor buttons
      saveBtn.disabled = true;
      saveAsBtn.disabled = true;
      downloadBtn.disabled = true;
      deleteBtn.disabled = true;

      updateModifiedIndicator();
    }

    function handleEditorChange(e) {
      state.currentContent = e.target.value;
      state.modified = state.currentContent !== state.originalContent;
      updateModifiedIndicator();
    }

    function updateModifiedIndicator() {
      modifiedIndicator.style.display = state.modified ? 'inline-block' : 'none';
      saveBtn.disabled = !state.modified;
    }

    // ---- UI Updates ----
    function updateConnectionStatus() {
      if (state.connected) {
        statusPill.textContent = 'Connected';
        statusPill.className = 'status-pill status-connected';
        connectBtn.textContent = 'Disconnect';
        connectBtn.classList.remove('primary');
        connectBtn.classList.add('danger');
        refreshBtn.disabled = false;
        newFileBtn.disabled = false;
      } else {
        statusPill.textContent = 'Disconnected';
        statusPill.className = 'status-pill status-disconnected';
        connectBtn.textContent = 'Connect Device';
        connectBtn.classList.remove('danger');
        connectBtn.classList.add('primary');
        refreshBtn.disabled = true;
        newFileBtn.disabled = true;

        fileList.innerHTML = '<div class="placeholder">Connect to a device to view files</div>';
        fileCount.textContent = '—';
      }
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ---- Event Handlers ----
    connectBtn.addEventListener('click', async () => {
      if (state.connected) {
        await disconnectDevice();
      } else {
        await connectDevice();
      }
    });

    refreshBtn.addEventListener('click', async () => {
      await loadFileList();
    });

    newFileBtn.addEventListener('click', () => {
      const filename = prompt('Enter filename (e.g., mycode.py):');
      if (!filename) return;

      const path = '/' + filename;

      // Add to file list
      state.files.push({
        name: filename,
        type: 'file',
        size: 0,
        path: path
      });

      renderFileList();

      // Open the new file
      state.currentFile = path;
      state.currentContent = '';
      state.originalContent = '';
      state.modified = true;

      showEditor('', filename);
    });

    saveBtn.addEventListener('click', async () => {
      if (!state.currentFile) return;
      await writeFileToDevice(state.currentFile, state.currentContent);
    });

    saveAsBtn.addEventListener('click', async () => {
      const filename = prompt('Save as (filename):', state.currentFile ? state.currentFile.replace('/', '') : 'newfile.py');
      if (!filename) return;

      const path = '/' + filename;
      await writeFileToDevice(path, state.currentContent);

      // Add to file list if new
      if (!state.files.find(f => f.path === path)) {
        state.files.push({
          name: filename,
          type: 'file',
          size: state.currentContent.length,
          path: path
        });
        renderFileList();
      }

      state.currentFile = path;
      fileName.textContent = filename;
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([state.currentContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = state.currentFile ? state.currentFile.replace('/', '') : 'file.txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    deleteBtn.addEventListener('click', async () => {
      if (!state.currentFile) return;
      await deleteFileFromDevice(state.currentFile);
    });

    // Warn on page unload if there are unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (state.modified) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // ---- Initialize ----
    updateConnectionStatus();
  </script>
</body>
</html>
